Week 4 AB Testing
Create a Test Metric
Saturday, August 5, 2023

==============================
Exercise 1:
Using the table from Exercise 4.3 and compute a metric that measures 
Whether a user created an order after their test assignment

Requirements: Even if a user had zero orders, we should have a row that counts 
their number of orders as zero

If the user is not in the experiment they should not be included
==============================

SELECT
  assignments.test_id,
  assignments.test_assignment,
  assignments.user_id,
  MAX (
    CASE
      WHEN orders.created_at > assignments.event_time THEN 1
      ELSE 0
    END
  ) did_order_after_assignment_binary
FROM
  (
    SELECT
      event_id,
      event_time,
      user_id,
      MAX(
        CASE
          WHEN parameter_name = 'test_id' THEN CAST(parameter_value AS INT)
          ELSE NULL
        END
      ) test_id,
      MAX(
        CASE
          WHEN parameter_name = 'test_assignment' THEN CAST(parameter_value AS INT)
          ELSE NULL
        END
      ) test_assignment
    FROM
      dsv1069.events
    WHERE
      event_name = 'test_assignment'
    GROUP BY
      event_id,
      event_time,
      user_id
  ) assignments
  LEFT JOIN dsv1069.orders ON orders.user_id = assignments.user_id
GROUP BY
  assignments.test_id,
  assignments.test_assignment,
  assignments.user_id

==============================
  Exercise 2:
Using the table from the previous exercise, add the following metrics 
1) the number of orders/invoices
2) the number of items/line-items ordered
3) the total revenue from the order after treatment
==============================

SELECT
  assignments.test_id,
  assignments.test_assignment,
  assignments.user_id,
  COUNT(
    DISTINCT(
      CASE
        WHEN orders.created_at > assignments.event_time THEN invoice_id
        ELSE NULL
      END
    )
  ) orders_after_assignment,
  COUNT(
    DISTINCT (
      CASE
        WHEN orders.created_at > assignments.event_time THEN line_item_id
        ELSE NULL
      END
    )
  ) items_after_assignment,
  SUM(
    (
      CASE
        WHEN orders.created_at > assignments.event_time THEN price
        ELSE 0
      END
    )
  ) total_revenue
FROM
  (
    SELECT
      event_id,
      event_time,
      user_id,
      MAX(
        CASE
          WHEN parameter_name = 'test_id' THEN CAST(parameter_value AS INT)
          ELSE NULL
        END
      ) test_id,
      MAX(
        CASE
          WHEN parameter_name = 'test_assignment' THEN CAST(parameter_value AS INT)
          ELSE NULL
        END
      ) test_assignment
    FROM
      dsv1069.events
    WHERE
      event_name = 'test_assignment'
    GROUP BY
      event_id,
      event_time,
      user_id
  ) assignments
  LEFT JOIN dsv1069.orders ON orders.user_id = assignments.user_id
GROUP BY
  assignments.test_id,
  assignments.test_assignment,
  assignments.user_id
