Week 3 SQL Problem Solving
Create a Rollup Table
Tuesday, August 1, 2023

==============================
Exercise 1: Create a subtable of orders per day. 
Make sure you decide whether you are counting invoices or line items.
==============================

SELECT
  date(created_at) AS DAY,
  invoice_id AS orders,
  line_item_id AS items
FROM
  dsv1069.orders
ORDER BY
  DAY

==============================
Exercise 2: “Check your joins”. We are still trying to count orders per day. 
In this step join the sub table from the previous exercise to the dates rollup table 
so we can get a row for every date. 
Check that the join works by just running a “select *” query

Exercise 3: “Clean up your Columns” In this step be sure to specify the columns you 
actually want to return, and if necessary do any aggregation needed to get a 
count of the orders made per day.
==============================

SELECT
  dsv1069.dates_rollup.date AS DAY,
  COUNT(DISTINCT invoice_id) AS orders,
  COUNT(DISTINCT line_item_id) AS items
FROM
  dsv1069.dates_rollup
  LEFT JOIN dsv1069.orders ON dsv1069.dates_rollup.date = date(created_at)
GROUP BY
  DAY
ORDER BY
  DAY


==============================
Exercise 4: Weekly Rollup. Figure out which parts of the JOIN condition need to be edited 
create 7 day rolling orders table.

Exercise 5: Column Cleanup. Finish creating the weekly rolling orders table, 
by performing any aggregation steps and naming your columns appropriately.
==============================

SELECT
  dates_rollup.date,
  COALESCE(SUM(orders), 0) AS rolling_orders,
  COALESCE(SUM(items), 0) AS rolling_items,
  count(*) AS number_of_rows
FROM
  dsv1069.dates_rollup
  LEFT JOIN (
    SELECT
      date(created_at) AS DAY,
      COUNT(DISTINCT invoice_id) AS orders,
      COUNT(DISTINCT line_item_id) AS items
    FROM
      dsv1069.orders
    GROUP BY
      DAY
    ORDER BY
      DAY
  ) AS counts_per_day ON dates_rollup.date >= counts_per_day.day
  AND dates_rollup.d7_ago < counts_per_day.day
GROUP BY
  dates_rollup.date
ORDER BY
  dates_rollup.date

  


